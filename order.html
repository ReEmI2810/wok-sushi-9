<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sushi Place â€” ×ª×¤×¨×™×˜ ×•×”×–×× ×”</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0e0e0f; --panel:#0f0f10; --muted:#b7b7b9; --white:#ffffff;
      --cta:#e4482f; --cta-hover:#d13f29; --card:#141416; --stroke:#222226; --radius:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--white);
      font-family:Inter,system-ui,Segoe UI,Arial,Helvetica,sans-serif;
      min-height:100vh; display:flex; flex-direction:column;
    }
    header{
      position:sticky; top:0; z-index:20;
      background:linear-gradient(180deg,#0e0e0f,rgba(14,14,15,.8));
      backdrop-filter:saturate(120%) blur(6px);
      border-bottom:1px solid var(--stroke);
    }
    .container{max-width:1100px; margin:0 auto; padding:16px}
    .topbar{display:flex; align-items:center; gap:12px; justify-content:space-between}
    .brand{display:flex; align-items:center; gap:10px}
    .brand .logo{
      width:40px; height:40px; border-radius:12px; background:#121214; border:1px solid var(--stroke);
      display:grid; place-items:center; font-weight:800;
    }
    .pill{border:1px solid var(--stroke); border-radius:999px; padding:8px 14px; color:var(--muted); font-size:.95rem; text-decoration:none}

    /* ===== refresh: categories + cards ===== */
    .categories{
      position:sticky; top:68px; z-index:10;
      background:linear-gradient(180deg,#0e0e0f,rgba(14,14,15,.7));
      padding:10px 0 12px; border-bottom:1px solid var(--stroke);
      display:flex; gap:8px; flex-wrap:wrap; margin-bottom:14px
    }
    .chip{
      background:#151518; border:1px solid #23232a; color:#fff;
      padding:8px 12px; border-radius:999px; cursor:pointer; font-size:.95rem;
      transition:transform .15s ease, background .2s ease, border-color .2s ease;
    }
    .chip:hover{transform:translateY(-1px)}
    .chip.active{background:#1f1f25; border-color:#3b3b46}

    .grid{display:grid; grid-template-columns:1fr 380px; gap:20px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    /* ×›×¨×˜×™×¡×™× ×× ×›×™×™× ×¢× ×ª××•× ×” ××œ××” */
    .cards{ display:grid; grid-template-columns:repeat(3,1fr); gap:16px; }
    @media (max-width:1024px){ .cards{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:720px){ .cards{grid-template-columns:1fr} }

    .card{
      background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); overflow:hidden;
      display:flex; flex-direction:column; padding:0;
    }
    .thumb{ width:100%; height:180px; background:#101012; border-bottom:1px solid #1e1e22; }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; filter:brightness(.95) }
    .info{ display:flex; flex-direction:column; gap:8px; padding:14px }
    .title{font-weight:800; font-size:1.05rem}
    .desc{color:var(--muted); font-size:.95rem; line-height:1.35}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:6px}
    .price{ font-weight:900}
    .btn{ border:none; background:var(--cta); color:#fff; border-radius:14px; padding:10px 14px; font-weight:800; cursor:pointer; transition:.18s; }
    .btn:hover{ background:var(--cta-hover); transform:translateY(-1px) }

    /* CART */
    .cart{
      position:sticky; top:84px; align-self:start;
      background:var(--panel); border:1px solid var(--stroke); border-radius:22px; padding:16px;
      max-height:calc(100vh - 100px); overflow:auto;
    }
    .cart h3{margin:6px 0 12px}
    .cart-empty{color:var(--muted); text-align:center; padding:20px 6px}
    .cart-item{ display:grid; grid-template-columns:1fr auto; gap:6px; padding:12px 0; border-bottom:1px dashed #26262a; }
    .cart-item:last-child{border-bottom:none}
    .item-title{font-weight:600}
    .item-meta{ color:var(--muted); font-size:.9rem }
    .qty-controls{ display:flex; align-items:center; gap:8px }
    .qty-btn{
      width:30px; height:30px; border-radius:10px; border:1px solid var(--stroke);
      background:#19191c; color:#fff; font-weight:800; cursor:pointer;
    }
    .qty-btn.edit{
      width:auto; padding:6px 10px; border-radius:10px; font-weight:700; border-color:#2a2a30;
    }
    .qty-btn.edit:hover{ background:#202026 }

    .summary{ margin-top:12px; padding-top:12px; border-top:1px solid var(--stroke); display:grid; gap:8px; font-size:.95rem; }
    .summary .row2{display:flex; justify-content:space-between; color:var(--muted)}
    .total{display:flex; justify-content:space-between; font-weight:800; font-size:1.1rem; margin-top:4px}
    .checkout{ margin-top:12px; width:100%; padding:14px; border-radius:16px; border:none; background:var(--cta); color:#fff; font-weight:800; cursor:pointer; }
    .checkout:disabled{opacity:.6; cursor:not-allowed}

    /* mobile floating bar */
    .floating{
      position:sticky; bottom:0; z-index:30; background:linear-gradient(180deg,transparent,rgba(14,14,15,.9) 30%, #0e0e0f 60%); padding:16px;
      display:none;
    }
    @media (max-width:980px){ .floating{display:block} .cart{display:none}}
    .floating button{ width:100%; padding:16px; border-radius:18px; border:1px solid var(--stroke); background:#141416; color:#fff; font-weight:800 }

    .drawer{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:flex-end; z-index:50; }
    .drawer.open{display:flex}
    .sheet{ width:100%; max-height:80vh; background:var(--panel); border-top-left-radius:24px; border-top-right-radius:24px; padding:16px; overflow:auto; border-top:1px solid var(--stroke); }
    .sheet .close{ background:#19191d; border:1px solid var(--stroke); color:#fff; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer; }
    .badge{font-size:.85rem; color:#fff; background:#2b2b2f; border:1px solid var(--stroke); padding:3px 8px; border-radius:999px}

    /* Options modal */
    .opt-group{border:1px solid var(--stroke); border-radius:16px; padding:12px}
    .opt-title{font-weight:700; margin-bottom:6px}
    .opt-line{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 0}
    .opt-line + .opt-line{border-top:1px dashed #26262a}
    .hint{color:var(--muted); font-size:.9rem}
    .counter{display:flex; align-items:center; gap:8px}
    .ctr-btn{width:28px; height:28px; border-radius:8px; border:1px solid var(--stroke); background:#19191d; color:#fff; font-weight:800; cursor:pointer}
    textarea.opt-note{width:100%; min-height:68px; background:#141416; color:#fff; border:1px solid var(--stroke); border-radius:14px; padding:10px; resize:vertical}
  </style>
</head>
<body>
  <header>
    <div class="container topbar">
      <div class="brand">
        <div class="logo">ğŸ£</div>
        <div>
          <div style="font-weight:800">Sushi Place</div>
          <div class="pill">××©×œ×•×—×™× â€¢ ××™×¡×•×£ ×¢×¦××™</div>
        </div>
      </div>
      <a class="pill" href="index.html">×—×–×¨×”</a>
    </div>
  </header>

  <main class="container" style="flex:1; width:100%">
    <h1>×ª×¤×¨×™×˜</h1>
    <div class="categories" id="categoryBar"></div>

    <div class="grid">
      <section id="menuArea">
        <div class="cards" id="cards"></div>
      </section>

      <!-- CART (×“×¡×§×˜×•×¤) -->
      <aside class="cart" id="cartBox">
        <h3>×”×¢×’×œ×” ×©×œ×™</h3>
        <div id="cartItems"></div>
        <div class="summary" id="summaryBox" style="display:none">
          <div class="row2"><span>×¡×™×›×•× ×‘×™× ×™×™×</span><span id="subTotal">â‚ª0</span></div>
          <div class="row2"><span>×“××™ ××©×œ×•×—</span><span id="deliveryFee">â‚ª0</span></div>
          <div class="row2"><span>×”× ×—×”</span><span id="discount">â‚ª0</span></div>
          <div class="total"><span>×œ×ª×©×œ×•×</span><span id="grandTotal">â‚ª0</span></div>
          <button class="checkout" id="checkoutBtn" disabled>×œ×”××©×š ×œ×ª×©×œ×•×</button>
        </div>
        <div class="cart-empty" id="emptyCart">×”×¢×’×œ×” ×¨×™×§×”. ×”×•×¡×£ ×× ×•×ª ××”×ª×¤×¨×™×˜.</div>
      </aside>
    </div>
  </main>

  <!-- MOBILE floating bar -->
  <div class="floating">
    <button id="openCartMobile"><span id="mobileSummary">×¢×’×œ×” â€” â‚ª0</span></button>
  </div>

  <!-- Drawer (mobile cart) -->
  <div class="drawer" id="drawer">
    <div class="sheet">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px">
        <h3 style="margin:0">×”×¢×’×œ×”</h3>
        <button class="close" id="closeDrawer">×¡×’×•×¨</button>
      </div>
      <div id="cartItemsM"></div>
      <div class="summary" id="summaryBoxM" style="display:none">
        <div class="row2"><span>×¡×™×›×•× ×‘×™× ×™×™×</span><span id="subTotalM">â‚ª0</span></div>
        <div class="row2"><span>×“××™ ××©×œ×•×—</span><span id="deliveryFeeM">â‚ª0</span></div>
        <div class="row2"><span>×”× ×—×”</span><span id="discountM">â‚ª0</span></div>
        <div class="total"><span>×œ×ª×©×œ×•×</span><span id="grandTotalM">â‚ª0</span></div>
        <button class="checkout" id="checkoutBtnM" disabled>×œ×”××©×š ×œ×ª×©×œ×•×</button>
      </div>
      <div class="cart-empty" id="emptyCartM">×”×¢×’×œ×” ×¨×™×§×”. ×”×•×¡×£ ×× ×•×ª ××”×ª×¤×¨×™×˜.</div>
    </div>
  </div>

  <!-- Options Modal -->
  <div id="optBackdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:70; align-items:center; justify-content:center;">
    <div id="optSheet" style="width:min(620px,92vw); background:#0f0f10; border:1px solid #222226; border-radius:22px; padding:18px; color:#fff;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px">
        <h3 id="optTitle" style="margin:0">×‘×—×™×¨×ª ××¤×©×¨×•×™×•×ª</h3>
        <button id="optClose" style="background:#19191d; border:1px solid #222226; color:#fff; border-radius:12px; padding:8px 12px; cursor:pointer">×¡×’×•×¨</button>
      </div>
      <div id="optContent" style="display:grid; gap:12px; max-height:60vh; overflow:auto"></div>

      <div class="opt-group">
        <div class="opt-title">×”×¢×¨×•×ª</div>
        <textarea id="optNote" class="opt-note" placeholder="×œ×œ× ×‘×¦×œ, ×œ×©×™× ×¨×•×˜×‘ ×‘×¦×“, ×§×•××” 2, ×§×•×“ ×œ×©×¢×¨..."></textarea>
      </div>

      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:12px; border-top:1px solid #222226; padding-top:10px">
        <div style="display:flex; align-items:center; gap:8px">
          <button id="qtyMinus" class="ctr-btn">âˆ’</button>
          <div id="qtyVal">1</div>
          <button id="qtyPlus" class="ctr-btn">+</button>
        </div>
        <button id="optAdd" style="background:#e4482f; border:none; color:#fff; border-radius:14px; padding:12px 18px; font-weight:800; cursor:pointer">
          ×”×•×¡×£ â€” <span id="optPrice">â‚ª0</span>
        </button>
      </div>
      <div class="hint" id="optHint" style="margin-top:8px"></div>
    </div>
  </div>

  <script>
    // ×¤×œ×™×™×¡×”×•×œ×“×¨ ×œ×ª××•× ×•×ª ×× ××™×Ÿ ×ª××•× ×” ×œ×× ×”
    const PLACEHOLDER_IMG = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="600" height="360"><rect width="100%" height="100%" fill="#141416"/><text x="50%" y="52%" text-anchor="middle" fill="#3b3b40" font-family="Inter,Arial" font-size="32">Sushi</text></svg>`);
  </script>
  <script src="menu-data.js"></script>

  <script>
    /* ××©×œ×•×—×™× */
    const DELIVERY = { flatFee: 15, freeOver: 180, minimum: 70 };

    /* ×¢×’×œ×” */
    const STORAGE_KEY = "CART_V3";
    const STATE_KEY   = "ORDER_STATE_V1";
    let CART = load(STORAGE_KEY, []);
    let ORDER_STATE = load(STATE_KEY, { mode:"pickup" });

    function load(k,def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } }
    function save(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
    const money = n => "â‚ª" + (Number(n)||0).toLocaleString('he-IL',{maximumFractionDigits:0});
    const els = {
      toggle: gid('cartToggle'), drawer: gid('cartDrawer'), close: gid('cartClose'), backdrop: gid('cartBackdrop'),
      items: gid('cartItems'), badge: gid('cartBadge'), sub: gid('subTotal'), fee: gid('deliveryFee'),
      feeRow: gid('deliveryRow'), grand: gid('grandTotal'), minNote: gid('minNote'), minAmount: gid('minAmount'),
      checkout: gid('checkoutBtn')
    };
    function gid(x){ return document.getElementById(x) }
    function openCart(){ els.drawer.classList.add('open'); els.backdrop.classList.add('show') }
    function closeCart(){ els.drawer.classList.remove('open'); els.backdrop.classList.remove('show') }
    els.toggle.addEventListener('click', openCart);
    els.close.addEventListener('click', closeCart);
    els.backdrop.addEventListener('click', closeCart);

    document.querySelectorAll('input[name="fulfillment"]').forEach(r=>{
      r.checked = r.value === ORDER_STATE.mode;
      r.addEventListener('change', e=>{ ORDER_STATE.mode = e.target.value; save(STATE_KEY, ORDER_STATE); renderCart(); });
    });

    function cartSubtotal(){ return CART.reduce((s,i)=> s + i.price*i.qty, 0) }
    function calcDelivery(sub){ if(ORDER_STATE.mode!=="delivery") return 0; return sub>=DELIVERY.freeOver ? 0 : DELIVERY.flatFee }
    function meetsMin(sub){ return ORDER_STATE.mode!=="delivery" || sub>=DELIVERY.minimum }

    function renderCart(){
      els.items.innerHTML = CART.map((it,ix)=>`
        <div class="cart-item" data-ix="${ix}">
          <div>
            <div class="title">${it.name}</div>
            <div class="muted">${optionsText(it.options)}</div>
            <div class="muted">${money(it.price)} ×œ×™×—'</div>
          </div>
          <div class="row-actions" style="flex-direction:column;align-items:end">
            <div class="qty"><button class="dec">âˆ’</button><span>${it.qty}</span><button class="inc">+</button></div>
            <div class="muted">${money(it.price*it.qty)}</div>
            <div class="row-actions">
              <button class="edit-btn">×¢×¨×•×š</button>
              <button class="remove-btn">×”×¡×¨</button>
            </div>
          </div>
        </div>`).join('');

      els.items.querySelectorAll('.cart-item').forEach(el=>{
        const ix = Number(el.dataset.ix);
        el.querySelector('.inc').addEventListener('click', ()=>{ CART[ix].qty++; save(STORAGE_KEY,CART); renderCart(); });
        el.querySelector('.dec').addEventListener('click', ()=>{ CART[ix].qty--; if(CART[ix].qty<=0) CART.splice(ix,1); save(STORAGE_KEY,CART); renderCart(); });
        el.querySelector('.remove-btn').addEventListener('click', ()=>{ CART.splice(ix,1); save(STORAGE_KEY,CART); renderCart(); });
        el.querySelector('.edit-btn').addEventListener('click', ()=> openModal({ mode:'edit', cartIndex:ix, item:CART[ix] }) );
      });

      const sub = cartSubtotal(), fee = calcDelivery(sub), grand = sub+fee;
      els.sub.textContent = money(sub); els.fee.textContent = money(fee); els.feeRow.style.display = ORDER_STATE.mode==="delivery"?"":"none";
      els.grand.textContent = money(grand);
      els.badge.textContent = CART.reduce((s,i)=>s+i.qty,0);
      els.minAmount.textContent = "â‚ª"+DELIVERY.minimum;
      els.minNote.style.display = ORDER_STATE.mode==="delivery"?"":"none";
      els.checkout.disabled = ORDER_STATE.mode==="delivery" && !meetsMin(sub);
      els.checkout.textContent = els.checkout.disabled ? "××™× ×™××•× ×œ××©×œ×•×—: â‚ª"+DELIVERY.minimum : "×”××©×š ×œ×¤×¨×˜×™×";
    }
    renderCart();

    els.checkout.addEventListener('click', ()=>{
      const sub = cartSubtotal(); if(ORDER_STATE.mode==="delivery" && !meetsMin(sub)) return;
      const payload = { mode:ORDER_STATE.mode, items:CART, subTotal:sub, deliveryFee:calcDelivery(sub), grandTotal:sub+calcDelivery(sub), timestamp:Date.now() };
      localStorage.setItem("CHECKOUT_PAYLOAD_V1", JSON.stringify(payload));
      location.href = "checkout.html";
    });

    /* ===== ××¤×¨×˜ ×ª××—×•×¨/×‘×—×™×¨×•×ª (×›×•×œ×œ ××•×¨×– ×œ×× ×ª ×”×©× ×™×¦×œ) ===== */
    const MENU_SPEC = {
      "maki-veg::8 ×™×—' â€¢ ××¦×” ×‘×—×•×¥": {
        basePrice: 23,
        options: {
          extras: { type:"multi", pricePer:3, items:[
            "×××§×™ ×˜××’×• (×—×‘×™×ª×” ×™×¤× ×™×ª)","×××§×™ ×§× ×¤×™×• (×“×œ×¢×ª ×™×¤× ×™×ª)","×××§×™ ×©×™×˜××§×™",
            "×××§×™ ××‘×•×§×“×•","×××§×™ ×‘×˜×˜×”","×××§×™ ×’×–×¨","×××§×™ ×‘×¦×œ ×™×¨×•×§"
          ]}
        }
      },
      "maki-fish::×××§×™ ×¡×œ××•×Ÿ": { basePrice:27 },
      "maki-fish::×××§×™ ×˜×•× ×”":  { basePrice:28 },

      "futomaki::+ 2 ×™×¨×§×•×ª": {
        basePrice:33,
        options:{ fish:{type:"single",items:["×¡×œ××•×Ÿ","×˜×•× ×”"]}, style:{type:"single",items:["× ×","××˜×•×’×Ÿ"]} }
      },
      "futomaki::×¦××—×•× ×™": { basePrice:28 },

      "insideout::+ 2 ×™×¨×§×•×ª": {
        basePrice:43,
        options:{ fish:{type:"single",items:["×¡×œ××•×Ÿ","×˜×•× ×”"]}, style:{type:"single",items:["× ×","××˜×•×’×Ÿ"]} }
      },
      "insideout::×¦××—×•× ×™": { basePrice:38 },

      "nigiri::2 ××¦×‘×¢×•×ª ××•×¨×– ×‘×¦×™×¤×•×™ ×˜×•× ×” / ×¡×œ××•×Ÿ": {
        basePrice:22, options:{ fish:{ type:"single", items:["×¡×œ××•×Ÿ","×˜×•× ×”"] } }
      },
      "nigiri::2 ××¦×‘×¢×•×ª ××•×¨×– ×‘×¦×™×¤×•×™ ×˜××’×• / ××‘×•×§×“×• (VEG)": {
        basePrice:19, options:{ veg:{ type:"single", items:["×˜××’×•","××‘×•×§×“×•"] } }
      },

      "combos::×¦××—×•× ×™×ª â€” 18 ×™×—'": { basePrice:79, options:{ nigiri:{ type:"single", items:["××‘×•×§×“×•","×˜××’×•"] } } },
      "combos::×¡×œ××•×Ÿ â€” 22 ×™×—'":  { basePrice:97 },
      "combos::×˜×•× ×” â€” 26 ×™×—'":   { basePrice:112 },
      "combos::×–×•×’×™×ª â€” 34 ×™×—'":  { basePrice:169 },

      "party::80 ×™×—' â€“ 5 ×¡×¤×™×™×©×œ ×¡×œ××•×Ÿ + 3 ×¡×¤×™×™×©×œ ×˜×•× ×”": { basePrice:239 },
      "party::××’×© ×¦××—×•× ×™ (80 ×™×—')": { basePrice:199 },
      "party::××’×© ×¡×¤×™×™×©×œ ×¦××—×•× ×™ (80 ×™×—')": { basePrice:349 },
      "party::××’×© ×¡×¤×™×™×©×œ ×“×’×™× (80 ×™×—')": { basePrice:389 },

      "starters::××’×¨×•×œ ×¦××—×•× ×™": { basePrice:13 },
      "starters::××’×¨×•×œ ×¢×•×£":    { basePrice:16 },
      "starters::×—××•×¦×™× ×™×¤× ×™×™×":{ basePrice:16 },
      "starters::××•×¨×– ×××•×“×”":   { basePrice:16 },
      "starters::××“×××”":        { basePrice:24 },
      "starters::××¨×§ ××™×¡×•":     { basePrice:23 },
      "starters::×¡×œ×˜ ××¦×•×ª":     { basePrice:23 },
      "starters::×’×™×•×–×” / ×“×™× ×¡××": {
        basePrice:35,
        options:{
          size:{ type:"size", pricesBy:{ "5 ×™×—×™×“×•×ª":35, "10 ×™×—×™×“×•×ª":65, "24 ×™×—×™×“×•×ª":132 }},
          mix:{ type:"multi", items:["×‘×˜×˜×”","×¤×˜×¨×™×•×ª","×¢×•×£","×‘×§×¨","××•×•×–"] }
        }
      },

      "wok::××•×§×¤×¥ ×™×¨×§×•×ª": { basePrice:45, options: wokOptions() },
      "wok::××•×§×¤×¥ ×¢×•×£":   { basePrice:50, options: wokOptions() },
      "wok::××•×§×¤×¥ ×˜×•×¤×•":  { basePrice:50, options: wokOptions() },
      "wok::××•×§×¤×¥ ×¡×™× ×˜×”": { basePrice:53, options: wokOptions() },
      "wok::××•×§×¤×¥ ××™×§×¡":  { basePrice:60, options: wokOptions() },

      /* ×›××Ÿ ×”×ª×•×¡×¤×ª ×©×‘×™×§×©×ª: ×‘×—×™×¨×ª ×¡×•×’ ××•×¨×– ×œ×©× ×™×¦×œ */
      "rice::×©× ×™×¦×œ ××•×¨×– ×™×¤× ×™": { basePrice:53, options:{ rice:{ type:"single", items:["××•×¨×– ×××•×“×”","××•×¨×– ××•×§×¤×¥ ×¢× ×™×¨×§×•×ª"] } } },
      "rice::×¢×•×£ ×—××•×¥ ××ª×•×§":   { basePrice:53 },
      "rice::×¢×•×£ ×‘×§××¨×™ ××“×•× ×¤×™×§× ×˜×™": { basePrice:53 },
      "rice::×‘×™×£ ×¨×™×¡":         { basePrice:53 },

      "soups::××¨×§ ×˜×•× ×™××": {
        basePrice:44,
        options:{ kind:{ type:"size", pricesBy:{ "×¦××—×•× ×™":44, "×˜×•×¤×•":49, "×¢×•×£":49, "×‘×§×¨":51 } } }
      },
      "soups::KOREN SOUP": {
        basePrice:44,
        options:{ kind:{ type:"size", pricesBy:{ "×¦××—×•× ×™":44, "×˜×•×¤×•":49, "×¢×•×£":49, "×‘×§×¨":51 } } }
      },

      "noodles::GREEN WOK": { basePrice:49, options:{ variant:{ type:"size", pricesBy:{ "×¦××—×•× ×™":49, "×¢×•×£":50, "×˜×•×¤×•":50, "×¡×™× ×˜×”":57, "××™×§×¡":64 } } } },
      "noodles::RED WOK":   { basePrice:49, options:{ variant:{ type:"size", pricesBy:{ "×¦××—×•× ×™":49, "×¢×•×£":50, "×˜×•×¤×•":50, "×¡×™× ×˜×”":57, "××™×§×¡":64 } } } },

      "noodles::×¤××“ ×ª××™ ×™×¨×§×•×ª": { basePrice:45 },
      "noodles::×¤××“ ×ª××™ ×˜×•×¤×•":  { basePrice:50 },
      "noodles::×¤××“ ×ª××™ ×¢×•×£":   { basePrice:50 },
      "noodles::×¤××“ ×ª××™ ×¡×™× ×˜×”": { basePrice:53 },
      "noodles::×¤××“ ×ª××™ ××™×§×¡":  { basePrice:60 },

      /* ×©×ª×™×™×” â€” ××™×Ÿ ×¨×˜×‘×™× */
      "drinks::××™×": { basePrice:10 },
      "drinks::LEO ×¡×•×“×”": { basePrice:10 },
      "drinks::×§×•×§×” ×§×•×œ×”": { basePrice:12 },
      "drinks::×§×•×œ×” ×–×™×¨×•": { basePrice:12 },
      "drinks::×¤×× ×˜×”": { basePrice:12 },
      "drinks::×¡×¤×¨×™×™×˜": { basePrice:12 },
      "drinks::×¤×™×•×–×˜×™": { basePrice:12 },
      "drinks::LEO ×‘×™×¨×”": { basePrice:16 },
      "drinks::×¡×™× ×’×”": { basePrice:16 },
      "drinks::×¦'×× ×’": { basePrice:16 },
      "drinks::×˜×•×‘×•×¨×’": { basePrice:16 },
      "drinks::×’×•×œ×“×¡×˜××¨": { basePrice:16 },
      "drinks::×§×¨×œ×¡×‘×¨×’": { basePrice:16 },
      "drinks::×”×™×™× ×§×™×Ÿ": { basePrice:16 },
      "drinks::×¡×˜×œ×”": { basePrice:16 },
      "drinks::×¤×¨×™×’×ª ×ª×¤×•×–×™×": { basePrice:10 },
      "drinks::×¤×¨×™×’×ª ×œ×™××•× ×“×”": { basePrice:10 },
      "drinks::×¤×¨×™×’×ª ××©×›×•×œ×™×•×ª": { basePrice:10 }
    };

    function wokOptions(){
      return {
        addOns: { type:"multi", pricePer:5, items:["×‘×™×¦×”","×¤×˜×¨×™×•×ª"] },
        upsize: { type:"size", pricesBy:{ "×œ×œ× ×”×’×“×œ×”":0, "×”×’×“×œ×ª 100×’×³ ×¢×•×£":8, "×”×’×“×œ×ª 100×’×³ ×˜×•×¤×•":8 } },
        sirloinExtra: { type:"toggle", label:"×ª×•×¡×¤×ª 100×’×³ ×¡×™× ×˜×”", price:10 }
      };
    }

    function firstNumberInText(txt){ const m = String(txt).replaceAll(',','').match(/(\d+)/); return m ? Number(m[1]) : 0; }
    function slugify(s){ return String(s).toLowerCase().normalize('NFKD').replace(/[^\w\s-]/g,'').replace(/\s+/g,'-'); }

    document.querySelectorAll('.menu-card').forEach(section=>{
      const secId = section.id || 'sec';
      section.querySelectorAll('li.item').forEach(li=>{
        const nameEl = li.querySelector('.name'); const priceEl = li.querySelector('.price');
        if(!nameEl) return;
        const name = nameEl.textContent.trim();
        const priceBase = priceEl ? firstNumberInText(priceEl.textContent) : 0;
        const id = `${secId}__${slugify(name)}`;
        const btn = document.createElement('button');
        btn.className = 'add-btn'; btn.textContent = '×”×•×¡×£ ×œ×”×–×× ×”';
        btn.addEventListener('click', ()=> openModal({ mode:'add', base:{ id, name, price:priceBase, section:secId } }) );
        li.appendChild(btn);
      });
    });

    /* ===== ××•×“××œ ===== */
    const md = {
      wrap: gid('modalWrap'), title: gid('mdTitle'), price: gid('mdPrice'), note: gid('mdNote'),
      qVal: gid('qVal'), qPlus: gid('qPlus'), qMinus: gid('qMinus'),
      grpFish: gid('grpFish'), grpStyle: gid('grpStyle'), grpSauce: gid('grpSauce'),
      fishRow: gid('fishRow'), styleRow: gid('styleRow'), sauceRow: gid('sauceRow'),
      /* ×—×“×©: ×§×‘×•×¦×ª ×‘×—×™×¨×ª ××•×¨×– */
      grpRice: gid('grpRice'), riceRow: gid('riceRow'),
      add: gid('mdAdd'), cancel: gid('mdCancel'), close: gid('mdClose')
    };

    let modalState = null;

    function optionsText(opt){
      if(!opt) return "";
      const a=[];
      if(opt.fish) a.push(opt.fish);
      if(opt.style) a.push(opt.style);
      if(opt.sauces?.length) a.push("×¨×˜×‘×™×: "+opt.sauces.join(", "));
      if(opt.extras?.length) a.push("×ª×•×¡×¤×•×ª: "+opt.extras.join(", "));
      if(opt.mix?.length) a.push("××™×§×¡: "+opt.mix.join(", "));
      if(opt.variant) a.push(opt.variant);
      if(opt.sizeChoice) a.push(opt.sizeChoice);
      if(opt.kind) a.push(opt.kind);
      if(opt.addOns?.length) a.push("×ª×•×¡×¤×•×ª: "+opt.addOns.join(", "));
      if(opt.upsize && opt.upsize!=="×œ×œ× ×”×’×“×œ×”") a.push(opt.upsize);
      if(opt.sirloinExtra) a.push("×ª×•×¡×¤×ª 100×’×³ ×¡×™× ×˜×”");
      if(opt.rice) a.push("××•×¨×–: "+opt.rice);  // ×™×•×¦×’ ×‘×©× ×™×¦×œ ××•×¨×– ×™×¤× ×™
      if(opt.nigiri) a.push("× ×™×’×™×¨×™: "+opt.nigiri);
      if(opt.veg) a.push(opt.veg);
      if(opt.note) a.push("×”×¢×¨×”: "+opt.note);
      return a.join(" Â· ");
    }

    function computeUnitPrice(basePrice, specOpt, sel){
      let p = basePrice;

      if(specOpt?.extras?.type==="multi" && sel.extras?.length){
        p += sel.extras.length * (specOpt.extras.pricePer||0);
      }
      if(specOpt?.size?.type==="size" && sel.sizeChoice){
        const map = specOpt.size.pricesBy||{}; p = (map[sel.sizeChoice] ?? p);
      }
      if(specOpt?.kind?.type==="size" && sel.kind){
        const map = specOpt.kind.pricesBy||{}; p = (map[sel.kind] ?? p);
      }
      if(specOpt?.variant?.type==="size" && sel.variant){
        const map = specOpt.variant.pricesBy||{}; p = (map[sel.variant] ?? p);
      }
      if(specOpt?.addOns?.type==="multi" && sel.addOns?.length){
        p += sel.addOns.length * (specOpt.addOns.pricePer||0);
      }
      if(specOpt?.upsize?.type==="size" && sel.upsize){
        const map = specOpt.upsize.pricesBy||{}; p += (map[sel.upsize] ?? 0);
      }
      if(specOpt?.sirloinExtra?.type==="toggle" && sel.sirloinExtra){
        p += (specOpt.sirloinExtra.price||0);
      }
      return p;
    }

    function openModal(ctx){
      modalState = {
        ctx, qty:1,
        basePrice:0, price:0,
        spec: null,
        options:{ fish:null, style:null, sauces:[], extras:[], addOns:[], mix:[], rice:null, note:"" }
      };

      let baseName, section, basePrice;
      if(ctx.mode==='add'){
        baseName = ctx.base.name;
        section  = ctx.base.section;
        basePrice= ctx.base.price;
      } else {
        const it=ctx.item; baseName=it.name; section=it.section; basePrice=it.basePrice ?? it.price;
        modalState.qty=it.qty; modalState.options=JSON.parse(JSON.stringify(it.options||{}));
      }

      const specKey = `${section}::${baseName}`;
      modalState.spec = MENU_SPEC[specKey] || null;
      if(modalState.spec?.basePrice!=null) basePrice = modalState.spec.basePrice;
      modalState.basePrice = basePrice;

      md.title.textContent = baseName;
      md.note.value = modalState.options.note || "";
      md.qVal.textContent = modalState.qty;

      const showFish  = !!(modalState.spec?.options?.fish);
      const showStyle = !!(modalState.spec?.options?.style);
      const showRice  = !!(modalState.spec?.options?.rice);

      md.grpFish.style.display  = showFish ? "" : "none";
      md.grpStyle.style.display = showStyle? "" : "none";
      md.grpRice.style.display  = showRice ? "" : "none";

      if(showFish){
        const list = modalState.spec.options.fish.items||[];
        md.fishRow.innerHTML = list.map(v=>`<button class="chip" data-value="${v}">${v}</button>`).join('');
        if(modalState.options.fish){
          md.fishRow.querySelectorAll('.chip').forEach(c=>{ if(c.dataset.value===modalState.options.fish) c.classList.add('active') });
        }
      } else { md.fishRow.innerHTML = ""; }

      if(showStyle){
        const list = modalState.spec.options.style.items||[];
        md.styleRow.innerHTML = list.map(v=>`<button class="chip" data-value="${v}">${v}</button>`).join('');
        if(modalState.options.style){
          md.styleRow.querySelectorAll('.chip').forEach(c=>{ if(c.dataset.value===modalState.options.style) c.classList.add('active') });
        }
      } else { md.styleRow.innerHTML = ""; }

      if(showRice){
        const list = modalState.spec.options.rice.items||[];
        md.riceRow.innerHTML = list.map(v=>`<button class="chip" data-value="${v}">${v}</button>`).join('');
        if(modalState.options.rice){
          md.riceRow.querySelectorAll('.chip').forEach(c=>{ if(c.dataset.value===modalState.options.rice) c.classList.add('active') });
        }
      } else { md.riceRow.innerHTML = ""; }

      const showSauce = section !== 'drinks';
      md.grpSauce.style.display = showSauce ? "" : "none";
      md.sauceRow.querySelectorAll('.sauce').forEach(s=>{
        s.classList.remove('active');
        if(modalState.options.sauces?.includes(s.dataset.value)) s.classList.add('active');
      });

      updatePrice();
      md.wrap.classList.add('show');
    }

    function closeModal(){ md.wrap.classList.remove('show') }

    function readDynamicSelections(){
      const sauces = [...md.sauceRow.querySelectorAll('.sauce.active')].map(x=>x.dataset.value);
      return { sauces };
    }

    function updatePrice(){
      const specOpt = modalState.spec?.options || {};
      const dynamic = readDynamicSelections();
      modalState.options = { ...modalState.options, ...dynamic };
      const unit = computeUnitPrice(modalState.basePrice, specOpt, modalState.options);
      modalState.price = unit;
      md.price.textContent = money(unit * modalState.qty);
    }

    gid('qPlus').addEventListener('click', ()=>{ modalState.qty++; gid('qVal').textContent=modalState.qty; updatePrice(); });
    gid('qMinus').addEventListener('click', ()=>{ modalState.qty=Math.max(1,modalState.qty-1); gid('qVal').textContent=modalState.qty; updatePrice(); });

    gid('fishRow').addEventListener('click', e=>{
      const b=e.target.closest('.chip'); if(!b)return;
      gid('fishRow').querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); modalState.options.fish=b.dataset.value; updatePrice();
    });
    gid('styleRow').addEventListener('click', e=>{
      const b=e.target.closest('.chip'); if(!b)return;
      gid('styleRow').querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); modalState.options.style=b.dataset.value; updatePrice();
    });
    /* ×—×“×©: ×‘×—×™×¨×ª ××•×¨×– */
    gid('riceRow').addEventListener('click', e=>{
      const b=e.target.closest('.chip'); if(!b)return;
      gid('riceRow').querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); modalState.options.rice=b.dataset.value; updatePrice();
    });

    gid('sauceRow').addEventListener('click', e=>{
      const s=e.target.closest('.sauce'); if(!s)return;
      if(s.classList.contains('active')){
        s.classList.remove('active');
      }else{
        const actives = gid('sauceRow').querySelectorAll('.sauce.active').length;
        if(actives>=3) return;
        s.classList.add('active');
      }
      updatePrice();
    });

    gid('mdAdd').addEventListener('click', ()=>{
      const displayName = modalState.ctx.mode==='add' ? modalState.ctx.base.name : modalState.ctx.item.name;
      const section     = modalState.ctx.mode==='add' ? modalState.ctx.base.section : modalState.ctx.item.section;

      if(modalState.ctx.mode==='add'){
        CART.push({
          id:`${section}__${displayName}`,
          name: displayName,
          section,
          basePrice: modalState.basePrice,
          price: modalState.price,
          qty: modalState.qty,
          options: modalState.options
        });
      }else{
        const ix=modalState.ctx.cartIndex;
        CART[ix].qty=modalState.qty;
        CART[ix].options=modalState.options;
        CART[ix].price = modalState.price;
        CART[ix].basePrice = modalState.basePrice;
      }
      save(STORAGE_KEY,CART); closeModal(); renderCart(); openCart();
    });

    gid('mdCancel').addEventListener('click', closeModal);
    gid('mdClose').addEventListener('click', closeModal);
    document.querySelector('#modalWrap .modal-bg').addEventListener('click', closeModal);
  </script>

</body>
</html>